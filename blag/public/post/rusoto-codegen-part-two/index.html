<!DOCTYPE html>
<html lang="en-us">
    <head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">

		<title>
				Rusoto codegen, part two &middot; Matthew Mayer&#39;s tech blog
		</title>

		
  		<link rel="stylesheet" href="/blag/public/css/style.css">
		<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Libre+Baskerville:400,400i,700">
		
		<link rel="icon" type="image/png" sizes="32x32" href="/blag/public/images/favicon-32x32.png">
		<link rel="icon" type="image/png" sizes="16x16" href="/blag/public/images/favicon-16x16.png">
		<link rel="apple-touch-icon" sizes="180x180" href="/blag/public/images/apple-touch-icon.png">

		
		<link href="" rel="alternate" type="application/rss+xml" title="Matthew Mayer&#39;s tech blog" />
	</head>

    <body>
        		<nav class="nav">
			<div class="nav-container">
				<a href="/blag/public/">
					<h2 class="nav-title">Matthew Mayer&#39;s tech blog</h2>
				</a>
				<ul>
    <li><a href="/blag/public/about">About</a></li>
    <li><a href="/blag/public/">Posts</a></li>
</ul>
			</div>
		</nav>

        

<main>
	<div class="post">
		<div class="post-info">
    <span>Written by</span>
        Matthew Mayer
        <br>
        <span>on&nbsp;</span><time datetime="2017-06-16 21:28:53 -0700 PDT">June 16, 2017</time>
</div>
		<h1 class="post-title">Rusoto codegen, part two</h1>
<div class="post-line"></div>

		

		<p>In the <a href="https://matthewkmayer.github.io/blag/public/post/rusoto-codegen/">previous post</a> we took a quick tour of the major pieces of <a href="https://github.com/rusoto/rusoto">Rusoto</a> code generation.  In this post we'll get deeper into code generation for the Simple Queue Service.</p>
<h2 id="picking-up-from-part-one">Picking up from part one</h2>
<p>Part one described a few parts of Rusoto codegen:</p>
<ol>
<li>Finding which services to generate</li>
<li>Making the service's crate</li>
<li>Generating the service and placing it inside its crate</li>
<li><code>rustfmt</code> the generated code to make it look pretty</li>
</ol>
<p>Step three is where this post will concentrate.  Since part one was written, some name spacing has changed but the code does the same thing.  In <a href="https://github.com/rusoto/rusoto/blob/master/service_crategen/src/main.rs">service_crategen's main.rs file</a>:</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#069;font-weight:bold">let</span><span style="color:#bbb"> </span><span style="color:#069;font-weight:bold">mut</span><span style="color:#bbb"> </span>gen_writer<span style="color:#bbb"> </span><span style="color:#555">=</span><span style="color:#bbb"> </span>BufWriter::new(gen_file);<span style="color:#bbb">
</span><span style="color:#bbb"></span>codegen::generator::generate_source(<span style="color:#555">&amp;</span>service,<span style="color:#bbb"> </span><span style="color:#555">&amp;</span><span style="color:#069;font-weight:bold">mut</span><span style="color:#bbb"> </span>gen_writer).unwrap();<span style="color:#bbb">
</span></code></pre></div><p>The <code>generate_source</code> function is defined in <a href="https://github.com/rusoto/rusoto/blob/master/service_crategen/src/commands/generate/codegen/mod.rs">service_crategen/src/commands/generate/codegen/mod.rs</a>:</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#069;font-weight:bold">pub</span><span style="color:#bbb"> </span><span style="color:#069;font-weight:bold">fn</span> <span style="color:#c0f">generate_source</span>(service: <span style="color:#069">&amp;</span><span style="color:#0a8;font-weight:bold">Service</span>,<span style="color:#bbb"> </span>writer: <span style="color:#069">&amp;</span><span style="color:#0a8;font-weight:bold">mut</span><span style="color:#bbb"> </span>FileWriter)<span style="color:#bbb"> </span>-&gt; <span style="color:#0a8;font-weight:bold">IoResult</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">    </span><span style="color:#069;font-weight:bold">match</span><span style="color:#bbb"> </span>service.protocol()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">        </span><span style="color:#c30">&#34;json&#34;</span><span style="color:#bbb"> </span><span style="color:#555">=</span><span style="color:#555">&gt;</span><span style="color:#bbb"> </span>generate(writer,<span style="color:#bbb"> </span>service,<span style="color:#bbb"> </span>JsonGenerator,<span style="color:#bbb"> </span>JsonErrorTypes),<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">        </span><span style="color:#c30">&#34;query&#34;</span><span style="color:#bbb"> </span><span style="color:#555">|</span><span style="color:#bbb"> </span><span style="color:#c30">&#34;ec2&#34;</span><span style="color:#bbb"> </span><span style="color:#555">=</span><span style="color:#555">&gt;</span><span style="color:#bbb"> </span>generate(writer,<span style="color:#bbb"> </span>service,<span style="color:#bbb"> </span>QueryGenerator,<span style="color:#bbb"> </span>XmlErrorTypes),<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">        </span><span style="color:#c30">&#34;rest-json&#34;</span><span style="color:#bbb"> </span><span style="color:#555">=</span><span style="color:#555">&gt;</span><span style="color:#bbb"> </span>generate(writer,<span style="color:#bbb"> </span>service,<span style="color:#bbb"> </span>RestJsonGenerator,<span style="color:#bbb"> </span>JsonErrorTypes),<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">        </span><span style="color:#c30">&#34;rest-xml&#34;</span><span style="color:#bbb"> </span><span style="color:#555">=</span><span style="color:#555">&gt;</span><span style="color:#bbb"> </span>generate(writer,<span style="color:#bbb"> </span>service,<span style="color:#bbb"> </span>RestXmlGenerator,<span style="color:#bbb"> </span>XmlErrorTypes),<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">        </span>protocol<span style="color:#bbb"> </span><span style="color:#555">=</span><span style="color:#555">&gt;</span><span style="color:#bbb"> </span>panic<span style="color:#555">!</span>(<span style="color:#c30">&#34;Unknown protocol {}&#34;</span>,<span style="color:#bbb"> </span>protocol),<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></code></pre></div><p>The function signature shows it takes a reference to a <code>Service</code> and a mutable reference to a <code>FileWriter</code>.  The <code>FileWriter</code> type is supplied by the <code>BufWriter</code> we created just before calling <code>generate_source</code>.  The <code>Service</code> type is declared in <a href="https://github.com/rusoto/rusoto/blob/master/service_crategen/src/service.rs">service.rs</a> in the service_crategen project:</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#099">#[</span><span style="color:#099">derive(Debug)</span><span style="color:#099">]</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#069;font-weight:bold">pub</span><span style="color:#bbb"> </span><span style="color:#069;font-weight:bold">struct</span> <span style="color:#0a8;font-weight:bold">Service</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">    </span>config: ::ServiceConfig,<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">    </span>definition: <span style="color:#0a8;font-weight:bold">ServiceDefinition</span><span style="color:#bbb">
</span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#069;font-weight:bold">impl</span><span style="color:#bbb"> </span>Service<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">    </span><span style="color:#069;font-weight:bold">pub</span><span style="color:#bbb"> </span><span style="color:#069;font-weight:bold">fn</span> <span style="color:#c0f">new</span>(config: <span style="color:#0a8;font-weight:bold">ServiceConfig</span>,<span style="color:#bbb"> </span>definition: <span style="color:#0a8;font-weight:bold">ServiceDefinition</span>)<span style="color:#bbb"> </span>-&gt; <span style="color:#0a8;font-weight:bold">Self</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">        </span>Service<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">            </span>config: <span style="color:#0a8;font-weight:bold">config</span>,<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">            </span>definition: <span style="color:#0a8;font-weight:bold">definition</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">    </span><span style="color:#069;font-weight:bold">pub</span><span style="color:#bbb"> </span><span style="color:#069;font-weight:bold">fn</span> <span style="color:#c0f">name</span>(<span style="color:#555">&amp;</span>self)<span style="color:#bbb"> </span>-&gt; <span style="color:#069">&amp;</span><span style="color:#078;font-weight:bold">str</span> {<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">        </span><span style="color:#069;font-weight:bold">match</span><span style="color:#bbb"> </span>self.definition.metadata.service_abbreviation<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">            </span><span style="color:#366">Some</span>(<span style="color:#069;font-weight:bold">ref</span><span style="color:#bbb"> </span>service_abbreviation)<span style="color:#bbb"> </span><span style="color:#555">=</span><span style="color:#555">&gt;</span><span style="color:#bbb"> </span>service_abbreviation.as_str(),<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">            </span><span style="color:#366">None</span><span style="color:#bbb"> </span><span style="color:#555">=</span><span style="color:#555">&gt;</span><span style="color:#bbb"> </span>self.definition.metadata.service_full_name.as_ref()<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">    </span><span style="color:#069;font-weight:bold">pub</span><span style="color:#bbb"> </span><span style="color:#069;font-weight:bold">fn</span> <span style="color:#c0f">full_name</span>(<span style="color:#555">&amp;</span>self)<span style="color:#bbb"> </span>-&gt; <span style="color:#069">&amp;</span><span style="color:#078;font-weight:bold">str</span> {<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">        </span><span style="color:#555">&amp;</span>self.definition.metadata.service_full_name<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">    </span><span style="color:#069;font-weight:bold">pub</span><span style="color:#bbb"> </span><span style="color:#069;font-weight:bold">fn</span> <span style="color:#c0f">protocol</span>(<span style="color:#555">&amp;</span>self)<span style="color:#bbb"> </span>-&gt; <span style="color:#069">&amp;</span><span style="color:#078;font-weight:bold">str</span> {<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">        </span><span style="color:#555">&amp;</span>self.definition.metadata.protocol<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span><span style="color:#bbb"></span>...<span style="color:#bbb">
</span></code></pre></div><p>The <code>Service</code> type wraps up both a <code>ServiceConfig</code> and <code>ServiceDefinition</code>.  ServiceDefinition is what we saw in part one and looked like this:</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#099">#[</span><span style="color:#099">derive(Debug, Deserialize)</span><span style="color:#099">]</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#069;font-weight:bold">pub</span><span style="color:#bbb"> </span><span style="color:#069;font-weight:bold">struct</span> <span style="color:#0a8;font-weight:bold">ServiceDefinition</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">    </span><span style="color:#069;font-weight:bold">pub</span><span style="color:#bbb"> </span>documentation: <span style="color:#366">Option</span><span style="color:#555">&lt;</span><span style="color:#366">String</span><span style="color:#555">&gt;</span>,<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">    </span><span style="color:#069;font-weight:bold">pub</span><span style="color:#bbb"> </span>examples: <span style="color:#366">Option</span><span style="color:#555">&lt;</span>BTreeMap<span style="color:#555">&lt;</span><span style="color:#366">String</span>,<span style="color:#bbb"> </span><span style="color:#366">String</span><span style="color:#555">&gt;</span><span style="color:#555">&gt;</span>,<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">    </span><span style="color:#069;font-weight:bold">pub</span><span style="color:#bbb"> </span>metadata: <span style="color:#0a8;font-weight:bold">Metadata</span>,<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">    </span><span style="color:#069;font-weight:bold">pub</span><span style="color:#bbb"> </span>operations: <span style="color:#0a8;font-weight:bold">BTreeMap</span><span style="color:#555">&lt;</span><span style="color:#366">String</span>,<span style="color:#bbb"> </span>Operation<span style="color:#555">&gt;</span>,<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">    </span><span style="color:#099">#[</span><span style="color:#099">serde(deserialize_with=</span><span style="color:#c30">&#34;</span><span style="color:#c30">ShapesMap::deserialize_shapes_map</span><span style="color:#c30">&#34;</span><span style="color:#099">)</span><span style="color:#099">]</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">    </span><span style="color:#069;font-weight:bold">pub</span><span style="color:#bbb"> </span>shapes: <span style="color:#0a8;font-weight:bold">BTreeMap</span><span style="color:#555">&lt;</span><span style="color:#366">String</span>,<span style="color:#bbb"> </span>Shape<span style="color:#555">&gt;</span>,<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">    </span><span style="color:#069;font-weight:bold">pub</span><span style="color:#bbb"> </span>version: <span style="color:#366">Option</span><span style="color:#555">&lt;</span><span style="color:#366">String</span><span style="color:#555">&gt;</span><span style="color:#bbb">
</span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></code></pre></div><p>ServiceConfig is populated from the list of services we want to generate.  It stores this JSON:</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#c30">&#34;sqs&#34;</span> <span style="color:#a00;background-color:#faa">:</span> {
    <span style="color:#309;font-weight:bold">&#34;version&#34;</span>: <span style="color:#c30">&#34;0.25.0&#34;</span>,
    <span style="color:#309;font-weight:bold">&#34;coreVersion&#34;</span>: <span style="color:#c30">&#34;0.25.0&#34;</span>,
    <span style="color:#309;font-weight:bold">&#34;protocolVersion&#34;</span>: <span style="color:#c30">&#34;2012-11-05&#34;</span>,
    <span style="color:#309;font-weight:bold">&#34;baseTypeName&#34;</span>: <span style="color:#c30">&#34;Sqs&#34;</span>
  }
</code></pre></div><p>in this form:</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#099">#[</span><span style="color:#099">derive(Clone, Debug, Deserialize)</span><span style="color:#099">]</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#069;font-weight:bold">pub</span><span style="color:#bbb"> </span><span style="color:#069;font-weight:bold">struct</span> <span style="color:#0a8;font-weight:bold">ServiceConfig</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">    </span><span style="color:#069;font-weight:bold">pub</span><span style="color:#bbb"> </span>version: <span style="color:#366">String</span>,<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">    </span><span style="color:#099">#[</span><span style="color:#099">serde(rename = </span><span style="color:#c30">&#34;</span><span style="color:#c30">coreVersion</span><span style="color:#c30">&#34;</span><span style="color:#099">)</span><span style="color:#099">]</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">    </span><span style="color:#069;font-weight:bold">pub</span><span style="color:#bbb"> </span>core_version: <span style="color:#366">String</span>,<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">    </span><span style="color:#099">#[</span><span style="color:#099">serde(rename = </span><span style="color:#c30">&#34;</span><span style="color:#c30">protocolVersion</span><span style="color:#c30">&#34;</span><span style="color:#099">)</span><span style="color:#099">]</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">    </span><span style="color:#069;font-weight:bold">pub</span><span style="color:#bbb"> </span>protocol_version: <span style="color:#366">String</span>,<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">    </span><span style="color:#099">#[</span><span style="color:#099">serde(rename = </span><span style="color:#c30">&#34;</span><span style="color:#c30">customDependencies</span><span style="color:#c30">&#34;</span><span style="color:#099">)</span><span style="color:#099">]</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">    </span><span style="color:#069;font-weight:bold">pub</span><span style="color:#bbb"> </span>custom_dependencies: <span style="color:#366">Option</span><span style="color:#555">&lt;</span>BTreeMap<span style="color:#555">&lt;</span><span style="color:#366">String</span>,<span style="color:#bbb"> </span>cargo::Dependency<span style="color:#555">&gt;</span><span style="color:#555">&gt;</span>,<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">    </span><span style="color:#099">#[</span><span style="color:#099">serde(rename = </span><span style="color:#c30">&#34;</span><span style="color:#c30">baseTypeName</span><span style="color:#c30">&#34;</span><span style="color:#099">)</span><span style="color:#099">]</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">    </span><span style="color:#069;font-weight:bold">pub</span><span style="color:#bbb"> </span>base_type_name: <span style="color:#366">String</span>
}<span style="color:#bbb">
</span></code></pre></div><p>Back to <code>generate_source</code>!</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#069;font-weight:bold">pub</span><span style="color:#bbb"> </span><span style="color:#069;font-weight:bold">fn</span> <span style="color:#c0f">generate_source</span>(service: <span style="color:#069">&amp;</span><span style="color:#0a8;font-weight:bold">Service</span>,<span style="color:#bbb"> </span>writer: <span style="color:#069">&amp;</span><span style="color:#0a8;font-weight:bold">mut</span><span style="color:#bbb"> </span>FileWriter)<span style="color:#bbb"> </span>-&gt; <span style="color:#0a8;font-weight:bold">IoResult</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">    </span><span style="color:#069;font-weight:bold">match</span><span style="color:#bbb"> </span>service.protocol()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">        </span><span style="color:#c30">&#34;json&#34;</span><span style="color:#bbb"> </span><span style="color:#555">=</span><span style="color:#555">&gt;</span><span style="color:#bbb"> </span>generate(writer,<span style="color:#bbb"> </span>service,<span style="color:#bbb"> </span>JsonGenerator,<span style="color:#bbb"> </span>JsonErrorTypes),<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">        </span><span style="color:#c30">&#34;query&#34;</span><span style="color:#bbb"> </span><span style="color:#555">|</span><span style="color:#bbb"> </span><span style="color:#c30">&#34;ec2&#34;</span><span style="color:#bbb"> </span><span style="color:#555">=</span><span style="color:#555">&gt;</span><span style="color:#bbb"> </span>generate(writer,<span style="color:#bbb"> </span>service,<span style="color:#bbb"> </span>QueryGenerator,<span style="color:#bbb"> </span>XmlErrorTypes),<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">        </span><span style="color:#c30">&#34;rest-json&#34;</span><span style="color:#bbb"> </span><span style="color:#555">=</span><span style="color:#555">&gt;</span><span style="color:#bbb"> </span>generate(writer,<span style="color:#bbb"> </span>service,<span style="color:#bbb"> </span>RestJsonGenerator,<span style="color:#bbb"> </span>JsonErrorTypes),<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">        </span><span style="color:#c30">&#34;rest-xml&#34;</span><span style="color:#bbb"> </span><span style="color:#555">=</span><span style="color:#555">&gt;</span><span style="color:#bbb"> </span>generate(writer,<span style="color:#bbb"> </span>service,<span style="color:#bbb"> </span>RestXmlGenerator,<span style="color:#bbb"> </span>XmlErrorTypes),<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">        </span>protocol<span style="color:#bbb"> </span><span style="color:#555">=</span><span style="color:#555">&gt;</span><span style="color:#bbb"> </span>panic<span style="color:#555">!</span>(<span style="color:#c30">&#34;Unknown protocol {}&#34;</span>,<span style="color:#bbb"> </span>protocol),<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></code></pre></div><p>From the <a href="https://github.com/boto/botocore/blob/develop/botocore/data/sqs/2012-11-05/service-2.json">botocore SQS definition</a> we know SQS uses the <code>query</code> protocol:</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#c30">&#34;metadata&#34;</span> <span style="color:#a00;background-color:#faa">:</span> {
    <span style="color:#309;font-weight:bold">&#34;apiVersion&#34;</span>:<span style="color:#c30">&#34;2012-11-05&#34;</span>,
    <span style="color:#309;font-weight:bold">&#34;endpointPrefix&#34;</span>:<span style="color:#c30">&#34;sqs&#34;</span>,
    <span style="color:#309;font-weight:bold">&#34;protocol&#34;</span>:<span style="color:#c30">&#34;query&#34;</span>,
    <span style="color:#309;font-weight:bold">&#34;serviceAbbreviation&#34;</span>:<span style="color:#c30">&#34;Amazon SQS&#34;</span>,
    <span style="color:#309;font-weight:bold">&#34;serviceFullName&#34;</span>:<span style="color:#c30">&#34;Amazon Simple Queue Service&#34;</span>,
    <span style="color:#309;font-weight:bold">&#34;signatureVersion&#34;</span>:<span style="color:#c30">&#34;v4&#34;</span>,
    <span style="color:#309;font-weight:bold">&#34;uid&#34;</span>:<span style="color:#c30">&#34;sqs-2012-11-05&#34;</span>,
    <span style="color:#309;font-weight:bold">&#34;xmlNamespace&#34;</span>:<span style="color:#c30">&#34;http://queue.amazonaws.com/doc/2012-11-05/&#34;</span>
  }
</code></pre></div><p>This means we'll be taking this branch in the <code>match</code> statement:</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#c30">&#34;query&#34;</span><span style="color:#bbb"> </span><span style="color:#555">|</span><span style="color:#bbb"> </span><span style="color:#c30">&#34;ec2&#34;</span><span style="color:#bbb"> </span><span style="color:#555">=</span><span style="color:#555">&gt;</span><span style="color:#bbb"> </span>generate(writer,<span style="color:#bbb"> </span>service,<span style="color:#bbb"> </span>QueryGenerator,<span style="color:#bbb"> </span>XmlErrorTypes),<span style="color:#bbb">
</span></code></pre></div><p>This passes the <code>writer</code> and <code>service</code> variables along with <code>QueryGenerator</code> and <code>XmlErrorTypes</code> into <code>generate</code>.  Let's look into <code>generate</code>, defined in <a href="https://github.com/rusoto/rusoto/blob/master/service_crategen/src/commands/generate/codegen/mod.rs">service_crategen/src/commands/generate/codegen/mod.rs</a>:</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#069;font-weight:bold">fn</span> <span style="color:#c0f">generate</span><span style="color:#555">&lt;</span>P,<span style="color:#bbb"> </span>E<span style="color:#555">&gt;</span>(writer: <span style="color:#069">&amp;</span><span style="color:#0a8;font-weight:bold">mut</span><span style="color:#bbb"> </span>FileWriter,<span style="color:#bbb"> </span>service: <span style="color:#069">&amp;</span><span style="color:#0a8;font-weight:bold">Service</span>,<span style="color:#bbb"> </span>protocol_generator: <span style="color:#0a8;font-weight:bold">P</span>,<span style="color:#bbb"> </span>error_type_generator: <span style="color:#0a8;font-weight:bold">E</span>)<span style="color:#bbb"> </span>-&gt; <span style="color:#0a8;font-weight:bold">IoResult</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">    </span><span style="color:#069;font-weight:bold">where</span><span style="color:#bbb"> </span>P: <span style="color:#0a8;font-weight:bold">GenerateProtocol</span>,<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">          </span>E: <span style="color:#0a8;font-weight:bold">GenerateErrorTypes</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">    </span>writeln<span style="color:#555">!</span>(writer,<span style="color:#bbb"> </span><span style="color:#a00;background-color:#faa">&#34;</span><span style="color:#099">#[</span><span style="color:#099">allow(warnings)</span><span style="color:#099">]</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">        </span><span style="color:#069;font-weight:bold">use</span><span style="color:#bbb"> </span>hyper::Client;<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">        </span><span style="color:#069;font-weight:bold">use</span><span style="color:#bbb"> </span>hyper::status::StatusCode;<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">        </span><span style="color:#069;font-weight:bold">use</span><span style="color:#bbb"> </span>rusoto_core::request::DispatchSignedRequest;<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">        </span><span style="color:#069;font-weight:bold">use</span><span style="color:#bbb"> </span>rusoto_core::region;<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">        </span><span style="color:#069;font-weight:bold">use</span><span style="color:#bbb"> </span>std::fmt;<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">        </span><span style="color:#069;font-weight:bold">use</span><span style="color:#bbb"> </span>std::error::Error;<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">        </span><span style="color:#069;font-weight:bold">use</span><span style="color:#bbb"> </span>rusoto_core::request::HttpDispatchError;<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">        </span><span style="color:#069;font-weight:bold">use</span><span style="color:#bbb"> </span>rusoto_core::credential::{{CredentialsError,<span style="color:#bbb"> </span>ProvideAwsCredentials}};<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">    </span><span style="color:#a00;background-color:#faa">&#34;</span>)<span style="color:#555">?</span>;<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">    </span>protocol_generator.generate_prelude(writer,<span style="color:#bbb"> </span>service)<span style="color:#555">?</span>;<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">    </span>generate_types(writer,<span style="color:#bbb"> </span>service,<span style="color:#bbb"> </span><span style="color:#555">&amp;</span>protocol_generator)<span style="color:#555">?</span>;<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">    </span>error_type_generator.generate_error_types(writer,<span style="color:#bbb"> </span>service)<span style="color:#555">?</span>;<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">    </span>generate_client(writer,<span style="color:#bbb"> </span>service,<span style="color:#bbb"> </span><span style="color:#555">&amp;</span>protocol_generator)<span style="color:#555">?</span>;<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">    </span>generate_tests(writer,<span style="color:#bbb"> </span>service)<span style="color:#555">?</span>;<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">    </span><span style="color:#366">Ok</span>(())<span style="color:#bbb">
</span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></code></pre></div><p>We're finally seeing some slightly more advanced Rust features: <code>generate&lt;P, E&gt;</code> means we're using generics and the <code>?</code> operator replaces the <code>try!</code> macro.</p>
<p>Breaking it down:</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#069;font-weight:bold">fn</span> <span style="color:#c0f">generate</span><span style="color:#555">&lt;</span>P,<span style="color:#bbb"> </span>E<span style="color:#555">&gt;</span>(writer: <span style="color:#069">&amp;</span><span style="color:#0a8;font-weight:bold">mut</span><span style="color:#bbb"> </span>FileWriter,<span style="color:#bbb"> </span>service: <span style="color:#069">&amp;</span><span style="color:#0a8;font-weight:bold">Service</span>,<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">    </span>protocol_generator: <span style="color:#0a8;font-weight:bold">P</span>,<span style="color:#bbb"> </span>error_type_generator: <span style="color:#0a8;font-weight:bold">E</span>)<span style="color:#bbb"> </span>-&gt; <span style="color:#0a8;font-weight:bold">IoResult</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">    </span><span style="color:#069;font-weight:bold">where</span><span style="color:#bbb"> </span>P: <span style="color:#0a8;font-weight:bold">GenerateProtocol</span>,<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">          </span>E: <span style="color:#0a8;font-weight:bold">GenerateErrorTypes</span><span style="color:#bbb"> </span>{<span style="color:#bbb"> </span>...<span style="color:#bbb">
</span></code></pre></div><p><code>generate</code> takes a total of four arguments.  Two are generics, <code>P</code> and <code>E</code>.  They are defined in the <code>where</code> block: <code>P: GenerateProtocol</code> means <code>P</code> accepts anything that fulfills the <code>GenerateProtocol</code> trait.  Similarly, <code>E</code> accepts anything that implements the <code>GenerateErrorTypes</code> trait.  This is used in the signature so the <code>protocol_generator</code> arg is anything that implements the <code>GenerateProtocol</code> trait and <code>error_type_generator</code> is for the <code>GenerateErrorTypes</code> trait.</p>
<p>Now that we've rephrased that a few times, let's go to the next part:</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust">writeln<span style="color:#555">!</span>(writer,<span style="color:#bbb"> </span><span style="color:#a00;background-color:#faa">&#34;</span><span style="color:#099">#[</span><span style="color:#099">allow(warnings)</span><span style="color:#099">]</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">  </span><span style="color:#069;font-weight:bold">use</span><span style="color:#bbb"> </span>hyper::Client;<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">  </span><span style="color:#069;font-weight:bold">use</span><span style="color:#bbb"> </span>hyper::status::StatusCode;<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">  </span><span style="color:#069;font-weight:bold">use</span><span style="color:#bbb"> </span>rusoto_core::request::DispatchSignedRequest;<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">  </span><span style="color:#069;font-weight:bold">use</span><span style="color:#bbb"> </span>rusoto_core::region;<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">  </span><span style="color:#069;font-weight:bold">use</span><span style="color:#bbb"> </span>std::fmt;<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">  </span><span style="color:#069;font-weight:bold">use</span><span style="color:#bbb"> </span>std::error::Error;<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">  </span><span style="color:#069;font-weight:bold">use</span><span style="color:#bbb"> </span>rusoto_core::request::HttpDispatchError;<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">  </span><span style="color:#069;font-weight:bold">use</span><span style="color:#bbb"> </span>rusoto_core::credential::{{CredentialsError,<span style="color:#bbb"> </span>ProvideAwsCredentials}};<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#a00;background-color:#faa">&#34;</span>)<span style="color:#555">?</span>;<span style="color:#bbb">
</span></code></pre></div><p>Now we're getting to Rust code for SQS!  This is our prelude to the service.  Every AWS service Rusoto supports has this code at the top of <code>generated.rs</code>.  Take a peek at <a href="https://github.com/rusoto/rusoto/blob/master/rusoto/services/sqs/src/generated.rs">SQS&rsquo; generated.rs file</a>.  This brings in all the items we need for talking to AWS: <a href="https://github.com/hyperium/hyper">hyper</a> for HTTP(s) requests, wrappers for signing AWS requests from <code>rusoto_core::request</code>, AWS regions from <code>rusoto_core::region</code>, etc&hellip;  We also bring in AWS credential providing helpers.</p>
<p>Here's the next part of <code>generate</code>:</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust">protocol_generator.generate_prelude(writer,<span style="color:#bbb"> </span>service)<span style="color:#555">?</span>;<span style="color:#bbb">
</span><span style="color:#bbb"></span>generate_types(writer,<span style="color:#bbb"> </span>service,<span style="color:#bbb"> </span><span style="color:#555">&amp;</span>protocol_generator)<span style="color:#555">?</span>;<span style="color:#bbb">
</span><span style="color:#bbb"></span>error_type_generator.generate_error_types(writer,<span style="color:#bbb"> </span>service)<span style="color:#555">?</span>;<span style="color:#bbb">
</span><span style="color:#bbb"></span>generate_client(writer,<span style="color:#bbb"> </span>service,<span style="color:#bbb"> </span><span style="color:#555">&amp;</span>protocol_generator)<span style="color:#555">?</span>;<span style="color:#bbb">
</span><span style="color:#bbb"></span>generate_tests(writer,<span style="color:#bbb"> </span>service)<span style="color:#555">?</span>;<span style="color:#bbb">
</span></code></pre></div><p>This section is tailored to the specific service being generated.  <code>protocol_generator</code> implements talking to AWS and <code>error_type_generator</code> handles all the errors AWS could return for the service.  We'll get to that right after the last part of <code>generate</code>:</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#366">Ok</span>(())<span style="color:#bbb">
</span></code></pre></div><p>If we hit here, everything is okay and we return the <code>Result</code> type with an empty object, <code>()</code>.</p>
<p>Back to the service-specific code generation!</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust">protocol_generator.generate_prelude(writer,<span style="color:#bbb"> </span>service)<span style="color:#555">?</span>;<span style="color:#bbb">
</span></code></pre></div><p>In here, the <code>protocol_generator</code> variable refers to <code>QueryGenerator</code>.  This is from the earlier <code>match</code> statement: <code>generate(writer, service, QueryGenerator, XmlErrorTypes)</code>.  <code>QueryGenerator</code> is implemented in <a href="https://github.com/rusoto/rusoto/blob/master/service_crategen/src/commands/generate/codegen/query.rs">service_crategen/src/commands/generate/codegen/query.rs</a>.  Here's how it implements the <code>GenerateProtocol</code> trait:</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#069;font-weight:bold">pub</span><span style="color:#bbb"> </span><span style="color:#069;font-weight:bold">struct</span> <span style="color:#0a8;font-weight:bold">QueryGenerator</span>;<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#069;font-weight:bold">impl</span><span style="color:#bbb"> </span>GenerateProtocol<span style="color:#bbb"> </span><span style="color:#069;font-weight:bold">for</span><span style="color:#bbb"> </span>QueryGenerator<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb"></span>...<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">  </span><span style="color:#069;font-weight:bold">fn</span> <span style="color:#c0f">generate_prelude</span>(<span style="color:#555">&amp;</span>self,<span style="color:#bbb"> </span>writer: <span style="color:#069">&amp;</span><span style="color:#0a8;font-weight:bold">mut</span><span style="color:#bbb"> </span>FileWriter,<span style="color:#bbb"> </span>_service: <span style="color:#069">&amp;</span><span style="color:#0a8;font-weight:bold">Service</span>)<span style="color:#bbb"> </span>-&gt; <span style="color:#0a8;font-weight:bold">IoResult</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">      </span>writeln<span style="color:#555">!</span>(writer,<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">               </span><span style="color:#a00;background-color:#faa">&#34;</span><span style="color:#069;font-weight:bold">use</span><span style="color:#bbb"> </span>std::<span style="color:#078;font-weight:bold">str</span>::FromStr;<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">          </span><span style="color:#069;font-weight:bold">use</span><span style="color:#bbb"> </span>xml::EventReader;<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">          </span><span style="color:#069;font-weight:bold">use</span><span style="color:#bbb"> </span>xml::reader::ParserConfig;<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">          </span><span style="color:#069;font-weight:bold">use</span><span style="color:#bbb"> </span>rusoto_core::param::{{Params,<span style="color:#bbb"> </span>ServiceParams}};<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">          </span><span style="color:#069;font-weight:bold">use</span><span style="color:#bbb"> </span>rusoto_core::signature::SignedRequest;<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">          </span><span style="color:#069;font-weight:bold">use</span><span style="color:#bbb"> </span>xml::reader::XmlEvent;<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">          </span><span style="color:#069;font-weight:bold">use</span><span style="color:#bbb"> </span>rusoto_core::xmlutil::{{Next,<span style="color:#bbb"> </span>Peek,<span style="color:#bbb"> </span>XmlParseError,<span style="color:#bbb"> </span>XmlResponse}};<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">          </span><span style="color:#069;font-weight:bold">use</span><span style="color:#bbb"> </span>rusoto_core::xmlutil::{{characters,<span style="color:#bbb"> </span>end_element,<span style="color:#bbb"> </span>start_element,<span style="color:#bbb"> </span>skip_tree,<span style="color:#bbb"> </span>peek_at_name}};<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">          </span><span style="color:#069;font-weight:bold">use</span><span style="color:#bbb"> </span>rusoto_core::xmlerror::<span style="color:#555">*</span>;<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">          </span><span style="color:#069;font-weight:bold">enum</span> <span style="color:#0a8;font-weight:bold">DeserializerNext</span><span style="color:#bbb"> </span>{{<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">              </span>Close,<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">              </span>Skip,<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">              </span>Element(<span style="color:#366">String</span>),<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">      </span>}}<span style="color:#a00;background-color:#faa">&#34;</span>)<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">  </span>}<span style="color:#bbb">
</span><span style="color:#bbb"></span>...<span style="color:#bbb">
</span></code></pre></div><p>There's more to that trait, but we'll focus on <code>generate_prelude</code>.  While we've already created a generic prelude all services share, the <code>query</code> type needs additional imports.  For example we need to parse the XML payloads returned by SQS, so we bring in items from the <a href="https://github.com/netvl/xml-rs">xml crate</a>.  We also bring in Rusoto xmlutil helpers to make the code more concise.</p>
<p>Moving on to <code>generate_types(writer, service, &amp;protocol_generator)?;</code>, it's in <a href="https://github.com/rusoto/rusoto/blob/master/service_crategen/src/commands/generate/codegen/mod.rs">service_crategen/src/commands/generate/codegen/mod.rs</a>:</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#069;font-weight:bold">fn</span> <span style="color:#c0f">generate_types</span><span style="color:#555">&lt;</span>P<span style="color:#555">&gt;</span>(writer: <span style="color:#069">&amp;</span><span style="color:#0a8;font-weight:bold">mut</span><span style="color:#bbb"> </span>FileWriter,<span style="color:#bbb"> </span>service: <span style="color:#069">&amp;</span><span style="color:#0a8;font-weight:bold">Service</span>,<span style="color:#bbb"> </span>protocol_generator: <span style="color:#069">&amp;</span><span style="color:#0a8;font-weight:bold">P</span>)<span style="color:#bbb"> </span>-&gt; <span style="color:#0a8;font-weight:bold">IoResult</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">  </span><span style="color:#069;font-weight:bold">where</span><span style="color:#bbb"> </span>P: <span style="color:#0a8;font-weight:bold">GenerateProtocol</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">  </span><span style="color:#069;font-weight:bold">let</span><span style="color:#bbb"> </span>(serialized_types,<span style="color:#bbb"> </span>deserialized_types)<span style="color:#bbb"> </span><span style="color:#555">=</span><span style="color:#bbb"> </span>filter_types(service);<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">  </span><span style="color:#069;font-weight:bold">for</span><span style="color:#bbb"> </span>(name,<span style="color:#bbb"> </span>shape)<span style="color:#bbb"> </span><span style="color:#069;font-weight:bold">in</span><span style="color:#bbb"> </span>service.shapes().iter()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">        </span><span style="color:#069;font-weight:bold">let</span><span style="color:#bbb"> </span>type_name<span style="color:#bbb"> </span><span style="color:#555">=</span><span style="color:#bbb"> </span>mutate_type_name(<span style="color:#555">&amp;</span>name);<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">        </span><span style="color:#09f;font-style:italic">// We generate enums for error types, so no need to create model objects for them
</span><span style="color:#09f;font-style:italic"></span><span style="color:#bbb">        </span><span style="color:#069;font-weight:bold">if</span><span style="color:#bbb"> </span>shape.exception()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">            </span><span style="color:#069;font-weight:bold">continue</span><span style="color:#bbb"></span><span style="color:#99f"></span>;<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">        </span><span style="color:#09f;font-style:italic">// If botocore includes documentation, clean it up a bit and use it
</span><span style="color:#09f;font-style:italic"></span><span style="color:#bbb">        </span><span style="color:#069;font-weight:bold">if</span><span style="color:#bbb"> </span><span style="color:#069;font-weight:bold">let</span><span style="color:#bbb"> </span><span style="color:#366">Some</span>(<span style="color:#069;font-weight:bold">ref</span><span style="color:#bbb"> </span>docs)<span style="color:#bbb"> </span><span style="color:#555">=</span><span style="color:#bbb"> </span>shape.documentation<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">            </span>writeln<span style="color:#555">!</span>(writer,<span style="color:#bbb"> </span><span style="color:#c30">&#34;#[doc=\&#34;{}\&#34;]&#34;</span>,<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">                               </span>docs.replace(<span style="color:#c30">&#34;\\&#34;</span>,<span style="color:#bbb"> </span><span style="color:#c30">&#34;\\\\&#34;</span>).replace(<span style="color:#c30">&#34;\&#34;&#34;</span>,<span style="color:#bbb"> </span><span style="color:#c30">&#34;\\\&#34;&#34;</span>))<span style="color:#555">?</span>;<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">        </span><span style="color:#069;font-weight:bold">let</span><span style="color:#bbb"> </span>deserialized<span style="color:#bbb"> </span><span style="color:#555">=</span><span style="color:#bbb"> </span>deserialized_types.contains(<span style="color:#555">&amp;</span>type_name);<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">        </span><span style="color:#069;font-weight:bold">let</span><span style="color:#bbb"> </span>serialized<span style="color:#bbb"> </span><span style="color:#555">=</span><span style="color:#bbb"> </span>serialized_types.contains(<span style="color:#555">&amp;</span>type_name);<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">        </span><span style="color:#09f;font-style:italic">// generate a rust type for the shape
</span><span style="color:#09f;font-style:italic"></span><span style="color:#bbb">        </span><span style="color:#069;font-weight:bold">if</span><span style="color:#bbb"> </span>type_name<span style="color:#bbb"> </span><span style="color:#555">!</span><span style="color:#555">=</span><span style="color:#bbb"> </span><span style="color:#c30">&#34;String&#34;</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">            </span><span style="color:#069;font-weight:bold">let</span><span style="color:#bbb"> </span>generated_type<span style="color:#bbb"> </span><span style="color:#555">=</span><span style="color:#bbb"> </span><span style="color:#069;font-weight:bold">match</span><span style="color:#bbb"> </span>shape.shape_type<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">                </span>ShapeType::Structure<span style="color:#bbb"> </span><span style="color:#555">=</span><span style="color:#555">&gt;</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">                    </span>generate_struct(service,<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">                                     </span><span style="color:#555">&amp;</span>type_name,<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">                                     </span><span style="color:#555">&amp;</span>shape,<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">                                     </span>serialized,<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">                                     </span>deserialized,<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">                                     </span>protocol_generator)<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">                </span>}<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">                </span>ShapeType::Map<span style="color:#bbb"> </span><span style="color:#555">=</span><span style="color:#555">&gt;</span><span style="color:#bbb"> </span>generate_map(<span style="color:#555">&amp;</span>type_name,<span style="color:#bbb"> </span><span style="color:#555">&amp;</span>shape),<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">                </span>ShapeType::List<span style="color:#bbb"> </span><span style="color:#555">=</span><span style="color:#555">&gt;</span><span style="color:#bbb"> </span>generate_list(<span style="color:#555">&amp;</span>type_name,<span style="color:#bbb"> </span><span style="color:#555">&amp;</span>shape),<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">                </span>shape_type<span style="color:#bbb"> </span><span style="color:#555">=</span><span style="color:#555">&gt;</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">                    </span>generate_primitive_type(<span style="color:#555">&amp;</span>type_name,<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">                                             </span>shape_type,<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">                                             </span>protocol_generator.timestamp_type())<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">                </span>}<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">            </span>};<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">            </span>writeln<span style="color:#555">!</span>(writer,<span style="color:#bbb"> </span><span style="color:#c30">&#34;{}&#34;</span>,<span style="color:#bbb"> </span>generated_type)<span style="color:#555">?</span>;<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">        </span><span style="color:#069;font-weight:bold">if</span><span style="color:#bbb"> </span>deserialized<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">            </span><span style="color:#069;font-weight:bold">if</span><span style="color:#bbb"> </span><span style="color:#069;font-weight:bold">let</span><span style="color:#bbb"> </span><span style="color:#366">Some</span>(deserializer)<span style="color:#bbb"> </span><span style="color:#555">=</span><span style="color:#bbb"> </span>protocol_generator.generate_deserializer(<span style="color:#555">&amp;</span>type_name,<span style="color:#bbb"> </span><span style="color:#555">&amp;</span>shape,<span style="color:#bbb"> </span>service)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">                </span>writeln<span style="color:#555">!</span>(writer,<span style="color:#bbb"> </span><span style="color:#c30">&#34;{}&#34;</span>,<span style="color:#bbb"> </span>deserializer)<span style="color:#555">?</span>;<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">            </span>}<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">        </span><span style="color:#069;font-weight:bold">if</span><span style="color:#bbb"> </span>serialized<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">            </span><span style="color:#069;font-weight:bold">if</span><span style="color:#bbb"> </span><span style="color:#069;font-weight:bold">let</span><span style="color:#bbb"> </span><span style="color:#366">Some</span>(serializer)<span style="color:#bbb"> </span><span style="color:#555">=</span><span style="color:#bbb"> </span>protocol_generator.generate_serializer(<span style="color:#555">&amp;</span>type_name,<span style="color:#bbb"> </span><span style="color:#555">&amp;</span>shape,<span style="color:#bbb"> </span>service)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">                </span>writeln<span style="color:#555">!</span>(writer,<span style="color:#bbb"> </span><span style="color:#c30">&#34;{}&#34;</span>,<span style="color:#bbb"> </span>serializer)<span style="color:#555">?</span>;<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">            </span>}<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">      </span>}<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">      </span><span style="color:#366">Ok</span>(())<span style="color:#bbb">
</span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></code></pre></div><p>The first thing we do is filter out the types.  This splits types into how they are used: inputs to AWS services and outputs.  This allows us to generate deserializers for outputs from AWS and serializers for inputs.  If we didn't do this, the generated code would have lots of unused code and make the services files larger than they have to be.  We then iterate over each shape in the service and generate its Rust equivalent.  Taking <code>generate_primitive_type</code> as an example:</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#069;font-weight:bold">fn</span> <span style="color:#c0f">generate_primitive_type</span>(name: <span style="color:#069">&amp;</span><span style="color:#078;font-weight:bold">str</span>,<span style="color:#bbb"> </span>shape_type: <span style="color:#0a8;font-weight:bold">ShapeType</span>,<span style="color:#bbb"> </span>for_timestamps: <span style="color:#069">&amp;</span><span style="color:#078;font-weight:bold">str</span>)<span style="color:#bbb"> </span>-&gt; <span style="color:#366">String</span> {<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">  </span><span style="color:#069;font-weight:bold">let</span><span style="color:#bbb"> </span>primitive_type<span style="color:#bbb"> </span><span style="color:#555">=</span><span style="color:#bbb"> </span><span style="color:#069;font-weight:bold">match</span><span style="color:#bbb"> </span>shape_type<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">    </span>ShapeType::Blob<span style="color:#bbb"> </span><span style="color:#555">=</span><span style="color:#555">&gt;</span><span style="color:#bbb"> </span><span style="color:#c30">&#34;Vec&lt;u8&gt;&#34;</span>,<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">    </span>ShapeType::Boolean<span style="color:#bbb"> </span><span style="color:#555">=</span><span style="color:#555">&gt;</span><span style="color:#bbb"> </span><span style="color:#c30">&#34;bool&#34;</span>,<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">    </span>ShapeType::Double<span style="color:#bbb"> </span><span style="color:#555">=</span><span style="color:#555">&gt;</span><span style="color:#bbb"> </span><span style="color:#c30">&#34;f64&#34;</span>,<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">    </span>ShapeType::Float<span style="color:#bbb"> </span><span style="color:#555">=</span><span style="color:#555">&gt;</span><span style="color:#bbb"> </span><span style="color:#c30">&#34;f32&#34;</span>,<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">    </span>ShapeType::Integer<span style="color:#bbb"> </span><span style="color:#555">=</span><span style="color:#555">&gt;</span><span style="color:#bbb"> </span><span style="color:#c30">&#34;i64&#34;</span>,<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">    </span>ShapeType::Long<span style="color:#bbb"> </span><span style="color:#555">=</span><span style="color:#555">&gt;</span><span style="color:#bbb"> </span><span style="color:#c30">&#34;i64&#34;</span>,<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">    </span>ShapeType::<span style="color:#366">String</span><span style="color:#bbb"> </span><span style="color:#555">=</span><span style="color:#555">&gt;</span><span style="color:#bbb"> </span><span style="color:#c30">&#34;String&#34;</span>,<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">    </span>ShapeType::Timestamp<span style="color:#bbb"> </span><span style="color:#555">=</span><span style="color:#555">&gt;</span><span style="color:#bbb"> </span>for_timestamps,<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">    </span>primitive_type<span style="color:#bbb"> </span><span style="color:#555">=</span><span style="color:#555">&gt;</span><span style="color:#bbb"> </span>panic<span style="color:#555">!</span>(<span style="color:#c30">&#34;Unknown primitive type: {:?}&#34;</span>,<span style="color:#bbb"> </span>primitive_type),<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">  </span>};<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#bbb">  </span>format<span style="color:#555">!</span>(<span style="color:#c30">&#34;pub type {} = {};&#34;</span>,<span style="color:#bbb"> </span>name,<span style="color:#bbb"> </span>primitive_type)<span style="color:#bbb">
</span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></code></pre></div><p>This is fairly straightforward.  Take the type defined in the service definition and map them to a Rust type.  Booleans map to <code>bool</code>, floats to <code>f32</code>, etc&hellip;  One special case is <code>for_timestamps</code> where we let the caller determine how it wants it to look.</p>
<p>The <code>generate_types</code> function also handles translating botocore documentation to rustdoc in the code.  Towards the end of the function it handles making serializers and deserializers if the shape needs them.  Finally it returns <code>Ok(())</code> to mark that part of codegen as complete.</p>
<p>The remainder of the code generation follows the same pattern: take the botocore service definition and translate that to Rust code.  Here's the parts we haven't covered:</p>
<div class="highlight"><pre style="background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust">error_type_generator.generate_error_types(writer,<span style="color:#bbb"> </span>service)<span style="color:#555">?</span>;<span style="color:#bbb">
</span><span style="color:#bbb"></span>generate_client(writer,<span style="color:#bbb"> </span>service,<span style="color:#bbb"> </span><span style="color:#555">&amp;</span>protocol_generator)<span style="color:#555">?</span>;<span style="color:#bbb">
</span><span style="color:#bbb"></span>generate_tests(writer,<span style="color:#bbb"> </span>service)<span style="color:#555">?</span>;<span style="color:#bbb">
</span></code></pre></div><p>Error types are errors AWS can return for requests.  We turn those into Rust code so we can have typed error messages.  <code>generate_client</code> is where the rubber meets the road and we create the Rust client for the service.  Take a look at <a href="https://rusoto.github.io/rusoto/rusoto_sqs/struct.SqsClient.html">SqsClient docs</a> to see what it generates.  Finally, <code>generate_tests</code> looks through botocore and translates the parsing tests from botocore to Rust code.  This means we have generated, automated tests for ensuring our deserializers and error handlers can handle examples of what AWS returns without actually making AWS calls.</p>
<h2 id="packaging-up-the-code">Packaging up the code</h2>
<p>After this deeper look of how we make Rust code, we still need to go over how the generated code is used in the crate.  Continuing with SQS, the next post will look into how the <code>rusoto_sqs</code> crate is created from scratch and populated with code from codegen covered in this post.</p>
<p>Thanks for reading!</p>


		
	</div>

	<div class="pagination">
		<a href="/blag/public/post/rusoto-codegen/" class="left arrow">&#8592;</a>
		<a href="/blag/public/post/rusoto-codegen-part-three/" class="right arrow">&#8594;</a>

		<a href="#" class="top">Top</a>
	</div>
</main>


        		<footer>
			<span>
			&copy; <time datetime="2019-12-16 20:23:11.660556 -0800 PST m=&#43;0.155107981">2019</time> . Made with <a href='https://gohugo.io'>Hugo</a> using the <a href='https://github.com/EmielH/tale-hugo/'>Tale</a> theme.
			</span>
		</footer>

    </body>
</html>
