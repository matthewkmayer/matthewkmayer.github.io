<h1>Rusoto sample/walkthrough</h1>

<h3>Prerequisites</h3>
Default VPC (for publically accessibly RDS instances), AWS access keys in some fashion, Rust nightly.

Switch to Rust nightly: `rustup default nightly`.

<h3>Rocket site</h3>
Follows the guide at https://rocket.rs/ .  Rocket is why nightly Rust is required: Rusoto and Diesel work on stable Rust.

<h3>Creating a Postgres RDS instance</h3>
See <a href="rusoto-rds/src/main.rs">rusoto-rds/src/main.rs</a> for the full code.

In the `rusoto-rds` directory, run `cargo run` to create a new database and wait for it to be available.
Once the endpoint is available, put that in the `.env` file in `rusoto-rocket`.<br /><br />

Example:<br /><br />

`DATABASE_URL=postgres://masteruser:TotallySecurePassword501@localhost/rusoto_rocket`<br /><br />

The code will:
<ul>
    <li>Create a new database</li>
    <li>Wait for it to be created</li>
    <li>Extract the endpoint to use with Diesel</li>
</ul>

<h3>Security groups</h3>
Using the AWS Console, add a new rule to the security group the RDS instance is using.  Allow inbound traffic on port 5432
from your IP address.

<h3>Diesel basics</h3>
Install with `cargo install diesel_cli --features "postgres" --no-default-features`.<br /><br />

Set up `.env` to have the connection string from the new RDS instance, including username and password:
DATABASE_URL=postgres://postgres:TotallySecurePassword501@localhost/rusoto_rocket<br /><br />

The up and down files have been populated in this sample:<br /><br />

(up file)
<blockquote>
    <p>
        CREATE TABLE hits (
            id SERIAL PRIMARY KEY,
            hits_so_far SERIAL NOT NULL
        )
    </p>
</blockquote>
<br /><br />
(down file)
<blockquote>
    <p>
        DROP TABLE hits
    </p>
</blockquote>

In the `rusoto-rocket` directory, run `diesel setup`.  This will connect to RDS and create the database with the required schema.<br /><br />

If the command times out, ensure your security groups allow inbound access from your IP address.<br /><br />

<h3>Connecting it all</h3>

Run `cargo run` in `rusoto-rocket` directory.  This will spin up a Rocket webserver on localhost:8000.
Visit that page to see the hit counter.  Refresh the page and see it increment by one for every page visit.
The data is stored in the RDS instance on AWS. :tada:

<h3>Cleaning up</h3>

To ensure the database doesn't keep running and potentially run up AWS bills, log in to the AWS Console and delete the
RDS DB instance.

<h3>Demo vs longer term infrastructure</h3>
Use Cloudformation via Troposphere.
Deploy via CodeDeploy, ElasticBeanstalk, Elastic Container Service instead of SCP.
<br /><br />
Testing notes:
`docker run --name postgres -e POSTGRES_PASSWORD=mysecretpassword -p 5432:5432 -d postgres:alpine`
